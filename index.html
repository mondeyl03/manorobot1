<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control Mano Rob√≥tica</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #f7faff, #e9f0ff);
      margin: 0; padding: 0;
      text-align: center; color: #222;
    }
    h1 {
      background: linear-gradient(90deg, #0078d7, #00a2ff);
      color: white; padding: 16px; margin: 0;
      font-size: 22px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 20px auto;
      width: 90%;
      max-width: 650px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }
    button {
      background: #0078d7;
      color: white; border: none;
      padding: 10px 18px; margin: 6px;
      border-radius: 6px; cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #005ea0; }
    .slider-container {
      display: flex; align-items: center;
      justify-content: space-between;
      margin: 8px 0;
    }
    .slider-label {
      width: 70px; text-align: left; font-weight: 600;
    }
    .slider {
      flex: 1; margin: 0 10px;
    }
    .arrow {
      background: #0078d7; color: white;
      width: 30px; height: 30px;
      border: none; border-radius: 50%;
      cursor: pointer; font-size: 18px;
      display: flex; align-items: center; justify-content: center;
    }
    .arrow:hover { background: #005ea0; }
    .value {
      min-width: 45px; text-align: center;
      font-weight: bold; color: #0078d7;
    }
    .section-title {
      color: #0078d7;
      font-weight: 700;
      margin-top: 20px;
      font-size: 18px;
    }
    .voice-btn {
      background: crimson;
      border-radius: 50%; width: 65px; height: 65px;
      color: white; font-size: 26px;
      display: flex; align-items: center; justify-content: center;
      margin: 10px auto; cursor: pointer;
      box-shadow: 0 4px 10px rgba(220,0,0,0.3);
      transition: all 0.2s;
    }
    .voice-btn.active {
      background: #28a745;
      box-shadow: 0 4px 10px rgba(40,167,69,0.4);
    }
    #vozLista {
      font-size: 14px;
      text-align: left;
      display: inline-block;
      margin-top: 8px;
      color: #444;
    }
  </style>
</head>
<body>
  <h1>Control de Mano Rob√≥tica</h1>

  <!-- Control manual -->
  <div class="panel">
    <h2 class="section-title">Control Manual</h2>
    <button onclick="sendCommand('/abrir')">Abrir Mano</button>
    <button onclick="sendCommand('/cerrar')">Cerrar Mano</button>
    <button onclick="sendCommand('/calibrar')">Calibrar Servos</button>

    <div id="sliders"></div>
  </div>

  <!-- Repeticiones manuales -->
  <div class="panel">
    <h2 class="section-title">Repeticiones Manuales</h2>
    <div>
      <label><input type="checkbox" value="pulgar"> Pulgar</label>
      <label><input type="checkbox" value="indice"> √çndice</label>
      <label><input type="checkbox" value="medio"> Medio</label>
      <label><input type="checkbox" value="anular"> Anular</label>
      <label><input type="checkbox" value="menique"> Me√±ique</label>
    </div>
    <p>Veces: <input type="number" id="veces" value="3" min="1"></p>
    <p>Cada: <input type="number" id="time" value="2" min="1">
      <select id="unit">
        <option value="s">segundos</option>
        <option value="m">minutos</option>
        <option value="h">horas</option>
      </select>
    </p>
    <button onclick="iniciarRepeticiones()">Iniciar Repetici√≥n</button>
    <button onclick="sendCommand('/pausar')">Pausar</button>
  </div>

  <!-- Terapia -->
  <div class="panel">
    <h2 class="section-title">Terapia de Oposici√≥n</h2>
    <p>Veces: <input type="number" id="terapiaVeces" value="2" min="1"></p>
    <p>Cada: <input type="number" id="terapiaTiempo" value="3" min="1">
      <select id="terapiaUnidad">
        <option value="s">segundos</option>
        <option value="m">minutos</option>
        <option value="h">horas</option>
      </select>
    </p>
    <button onclick="iniciarTerapia()">Iniciar Terapia</button>
    <button onclick="sendCommand('/detenerTerapia')">Detener Terapia</button>
  </div>

  <!-- Comando de voz -->
  <div class="panel">
    <h2 class="section-title">Comando de Voz</h2>
    <div id="micBtn" class="voice-btn" onclick="startVoice()">üé§</div>
    <p id="vozEstado">Micr√≥fono inactivo</p>
    <div id="vozLista">
      <b>Comandos disponibles:</b><br>
      ‚Ä¢ ‚ÄúAbrir mano‚Äù<br>
      ‚Ä¢ ‚ÄúCerrar mano‚Äù<br>
      ‚Ä¢ ‚ÄúIniciar terapia‚Äù o ‚ÄúTerapia‚Äù<br>
      ‚Ä¢ ‚ÄúPausar‚Äù o ‚ÄúDetener‚Äù<br>
      ‚Ä¢ ‚ÄúMover [dedo] a [n√∫mero] grados‚Äù (ej: mover √≠ndice a 30 grados)
    </div>
  </div>

  <script>
    const espIP = "http://172.19.123.247"; // Cambia si tu ESP32 tiene otra IP
    const limits = { pulgar:25, indice:65, medio:45, anular:45, menique:40 };

    // === Crear sliders ===
    const slidersDiv = document.getElementById("sliders");
    for (const [dedo, max] of Object.entries(limits)) {
      const row = document.createElement("div");
      row.className = "slider-container";
      row.innerHTML = `
        <div class="slider-label">${dedo.charAt(0).toUpperCase()+dedo.slice(1)}</div>
        <button class="arrow" onclick="adjust('${dedo}', -1)">‚óÄÔ∏è</button>
        <input type="range" min="0" max="${max}" value="0" id="${dedo}" class="slider" oninput="updateValue('${dedo}', this.value); moveFinger('${dedo}', this.value)">
        <button class="arrow" onclick="adjust('${dedo}', 1)">‚ñ∂Ô∏è</button>
        <div class="value" id="v_${dedo}">0¬∞</div>
      `;
      slidersDiv.appendChild(row);
    }

    function updateValue(d, v) { document.getElementById(`v_${d}`).innerText = v + "¬∞"; }

    async function sendCommand(path) {
      try { await fetch(`${espIP}${path}`); }
      catch (err) { console.warn("No se pudo conectar con ESP32:", err); }
    }

    async function moveFinger(dedo, angulo) {
      try { await fetch(`${espIP}/mover?dedo=${dedo}&angulo=${angulo}`); }
      catch (err) { console.warn("Error moviendo dedo:", err); }
    }

    function adjust(dedo, delta) {
      const s = document.getElementById(dedo);
      let val = parseInt(s.value) + delta;
      val = Math.min(Math.max(val, 0), limits[dedo]);
      s.value = val;
      updateValue(dedo, val);
      moveFinger(dedo, val);
    }

    async function iniciarRepeticiones() {
      const dedos = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(c => c.value);
      const veces = document.getElementById("veces").value;
      const tiempo = document.getElementById("time").value;
      const unidad = document.getElementById("unit").value;
      const dedosParam = dedos.length ? dedos.join(",") : "todos";
      await sendCommand(`/repetir?dedos=${dedosParam}&veces=${veces}&tiempo=${tiempo}&unidad=${unidad}`);
    }

    async function iniciarTerapia() {
      const veces = document.getElementById("terapiaVeces").value;
      const tiempo = document.getElementById("terapiaTiempo").value;
      const unidad = document.getElementById("terapiaUnidad").value;
      await sendCommand(`/iniciarTerapia?veces=${veces}&tiempo=${tiempo}&unidad=${unidad}`);
    }

    // === Reconocimiento de voz ===
  function startVoice() {
    const mic = document.getElementById("micBtn");
    const estado = document.getElementById("vozEstado");

    if (!("webkitSpeechRecognition" in window)) {
      alert("Tu navegador no soporta reconocimiento de voz");
      return;
    }

    const recog = new webkitSpeechRecognition();
    recog.lang = "es-ES";
    recog.continuous = true; // escucha continuo
    recog.interimResults = false;

    recog.onstart = () => {
      mic.classList.add("active");
      estado.textContent = "üéôÔ∏è Escuchando...";
    };

    recog.onresult = (event) => {
      const last = event.results.length - 1;
      const t = event.results[last][0].transcript.toLowerCase().trim();
      estado.textContent = `Comando detectado: "${t}"`;

      if (t.includes("abrir")) sendCommand("/abrir");
      else if (t.includes("cerrar")) sendCommand("/cerrar");
      else if (t.includes("terapia")) sendCommand("/iniciarTerapia?veces=2&tiempo=3&unidad=s");
      else if (t.includes("pausar") || t.includes("detener")) {
        sendCommand("/pausar");
        sendCommand("/detenerTerapia");
      }
      else if (t.includes("mover")) {
        const match = t.match(/(pulgar|indice|medio|anular|me√±ique|menique).*?(\d+)/);
        if (match) {
          const dedo = match[1].replace("me√±ique","menique");
          const ang = parseInt(match[2]);
          fetch(`${espIP}/mover?dedo=${dedo}&angulo=${ang}`);
        } else estado.textContent = "No entend√≠ el dedo o √°ngulo";
      } else estado.textContent = "Comando no reconocido";
    };

    recog.onerror = (e) => {
      estado.textContent = "Error de voz: " + e.error;
      mic.classList.remove("active");
    };

    recog.onend = () => {
      mic.classList.remove("active");
      estado.textContent = "Micr√≥fono inactivo";
    };

    recog.start();
  }
</script>
</body>
</html>
